<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Voice Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Update Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFj83jGuDsGRb4KVRVeBgyQQ0LuiGTufA",
            authDomain: "oaauth-e0c4d.firebaseapp.com",
            projectId: "oaauth-e0c4d",
            storageBucket: "oaauth-e0c4d.firebasestorage.app",
            messagingSenderId: "76089646716",
            appId: "1:76089646716:web:7563461b855ce67e56b3f9",
            measurementId: "G-KJZ6DQD73B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth; // Make auth available globally
    </script>
    <style>
        body {
            background-color: #1f2937;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <div id="joinForm" class="bg-gray-700 p-6 rounded-lg shadow-lg">
        <input type="text" id="nameInput" placeholder="Enter your name" class="w-full p-2 mb-4 bg-gray-600 rounded text-white">
        <button id="joinButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Join Room</button>
    </div>

    <div id="roomView" class="w-full max-w-4xl hidden">
        <div class="mb-4 flex justify-between items-center">
            <h2 class="text-2xl font-bold">Voice Chat Room</h2>
            <button id="copyLinkButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Copy Room Link</button>
        </div>
        <div id="participantsGrid" class="grid grid-cols-3 gap-4">
            <!-- Participant slots will be dynamically added here -->
        </div>
    </div>

    <script>
        // Update signaling server URL
        const signalingServer = 'wss://signal-v2-6203u5gsn-cullen-harrisons-projects.vercel.app/';
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 2000; // 2 seconds

        let localStream;
        let peerConnections = {};
        let localName;
        let roomId;

        const joinForm = document.getElementById('joinForm');
        const roomView = document.getElementById('roomView');
        const nameInput = document.getElementById('nameInput');
        const joinButton = document.getElementById('joinButton');
        const copyLinkButton = document.getElementById('copyLinkButton');
        const participantsGrid = document.getElementById('participantsGrid');

        joinButton.addEventListener('click', joinRoom);
        copyLinkButton.addEventListener('click', copyRoomLink);

        function joinRoom() {
            localName = nameInput.value.trim();
            if (!localName) {
                alert('Please enter your name');
                return;
            }

            roomId = generateRoomId();
            joinForm.classList.add('hidden');
            roomView.classList.remove('hidden');

            initializeParticipantSlots();
            connectToSignalingServer();
            setupLocalMedia();
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function initializeParticipantSlots() {
            for (let i = 0; i < 12; i++) {
                const slot = document.createElement('div');
                slot.className = 'bg-gray-700 p-4 rounded-lg flex items-center justify-center opacity-50';
                slot.innerHTML = '<span class="text-gray-400">Empty Slot</span>';
                participantsGrid.appendChild(slot);
            }
        }

        function connectToSignalingServer() {
            try {
                socket = new WebSocket(signalingServer);

                socket.onopen = () => {
                    console.log('Connected to signaling server');
                    reconnectAttempts = 0; // Reset reconnect attempts on successful connection
                    socket.send(JSON.stringify({ type: 'join', room: roomId, name: localName }));
                };

                socket.onmessage = async (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        switch (message.type) {
                            case 'user-joined':
                                handleUserJoined(message.userId, message.name);
                                break;
                            case 'offer':
                                await handleOffer(message.offer, message.userId);
                                break;
                            case 'answer':
                                await handleAnswer(message.answer, message.userId);
                                break;
                            case 'ice-candidate':
                                handleNewICECandidate(message.candidate, message.userId);
                                break;
                        }
                    } catch (error) {
                        console.error('Error handling message:', error);
                    }
                };

                socket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    handleReconnection();
                };

                socket.onclose = () => {
                    console.log('Disconnected from signaling server');
                    handleReconnection();
                };
            } catch (error) {
                console.error('Error creating WebSocket:', error);
                handleReconnection();
            }
        }

        function handleReconnection() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                setTimeout(connectToSignalingServer, reconnectDelay);
            } else {
                console.error('Max reconnection attempts reached');
                alert('Unable to connect to the signaling server. Please refresh the page to try again.');
            }
        }

        async function setupLocalMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                updateParticipantSlot(0, localName);
            } catch (error) {
                console.error('Error accessing media devices:', error);
            }
        }

        function handleUserJoined(userId, name) {
            console.log(`${name} joined the room`);
            updateParticipantSlot(getEmptySlotIndex(), name);
            createPeerConnection(userId, name);
        }

        function createPeerConnection(userId, name) {
            const peerConnection = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        userId: userId
                    }));
                }
            };

            peerConnection.ontrack = (event) => {
                // Handle remote audio stream
                const audioElement = new Audio();
                audioElement.srcObject = event.streams[0];
                audioElement.play();
            };

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnections[userId] = peerConnection;

            return peerConnection;
        }

        async function handleOffer(offer, userId) {
            const peerConnection = peerConnections[userId] || createPeerConnection(userId);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.send(JSON.stringify({
                type: 'answer',
                answer: answer,
                userId: userId
            }));
        }

        async function handleAnswer(answer, userId) {
            const peerConnection = peerConnections[userId];
            if (peerConnection) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            }
        }

        function handleNewICECandidate(candidate, userId) {
            const peerConnection = peerConnections[userId];
            if (peerConnection) {
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            }
        }

        function updateParticipantSlot(index, name) {
            const slots = participantsGrid.children;
            if (index >= 0 && index < slots.length) {
                const slot = slots[index];
                slot.className = 'bg-gray-700 p-4 rounded-lg flex items-center justify-center opacity-100';
                slot.innerHTML = `
                    <svg class="w-8 h-8 mr-2" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                    <span>${name}</span>
                `;
            }
        }

        function getEmptySlotIndex() {
            const slots = participantsGrid.children;
            for (let i = 0; i < slots.length; i++) {
                if (slots[i].classList.contains('opacity-50')) {
                    return i;
                }
            }
            return -1;
        }

        function copyRoomLink() {
            const roomLink = `${window.location.href}?room=${roomId}`;
            navigator.clipboard.writeText(roomLink).then(() => {
                alert('Room link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy room link:', err);
            });
        }

        // Check if user is joining an existing room
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const joinRoomId = urlParams.get('room');
            if (joinRoomId) {
                roomId = joinRoomId;
                joinForm.classList.remove('hidden');
                roomView.classList.add('hidden');
            }
        };
    </script>
</body>
</html>