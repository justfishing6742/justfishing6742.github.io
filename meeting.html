import React, { useState, useRef, useEffect } from 'react';
import { initializeApp } from "firebase/app";
import { getAuth, onAuthStateChanged } from "firebase/auth";

const firebaseConfig = {
  apiKey: "AIzaSyCFj83jGuDsGRb4KVRVeBgyQQ0LuiGTufA",
  authDomain: "oaauth-e0c4d.firebaseapp.com",
  projectId: "oaauth-e0c4d",
  storageBucket: "oaauth-e0c4d.firebasestorage.app",
  messagingSenderId: "76089646716",
  appId: "1:76089646716:web:7563461b855ce67e56b3f9",
  measurementId: "G-KJZ6DQD73B"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const VoiceChatRoom = () => {
  const [showJoinForm, setShowJoinForm] = useState(true);
  const [name, setName] = useState('');
  const [roomLink, setRoomLink] = useState('');
  const [participants, setParticipants] = useState([]);
  const ws = useRef(null);
  const peerConnection = useRef(null);
  const dataChannel = useRef(null);

  useEffect(() => {
    const roomId = new URLSearchParams(window.location.search).get('room') || Math.random().toString(36).substring(2, 15);
    setRoomLink(`${window.location.origin}${window.location.pathname}?room=${roomId}`);
    
    ws.current = new WebSocket('wss://signal-v2-6203u5gsn-cullen-harrisons-projects.vercel.app');
    
    ws.current.onopen = () => console.log('WebSocket connection established');
    
    ws.current.onmessage = handleMessage;
    
    ws.current.onerror = (error) => {
      console.error('WebSocket error:', error);
      alert('WebSocket connection error. Please try again later.');
    };
    
    ws.current.onclose = (event) => {
      console.log('WebSocket connection closed:', event);
      if (!event.wasClean) {
        alert('WebSocket connection closed unexpectedly. Please try again later.');
      }
    };

    return () => {
      ws.current.close();
    };
  }, []);

  const handleJoin = () => {
    if (!name) return;
    setShowJoinForm(false);
    const roomId = new URLSearchParams(window.location.search).get('room') || Math.random().toString(36).substring(2, 15);
    setRoomLink(`${window.location.origin}${window.location.pathname}?room=${roomId}`);
    
    ws.current.send(JSON.stringify({
      type: 'join',
      name: name,
      room: roomId
    }));

    setParticipants([{ name }]);

    setupPeerConnection();
  };

  const copyLink = () => {
    navigator.clipboard.writeText(roomLink);
  };

  const handleMessage = (event) => {
    const message = JSON.parse(event.data);

    switch (message.type) {
      case 'userJoined':
        setParticipants((prevParticipants) => [...prevParticipants, { name: message.name }]);
        break;
      case 'userLeft':
        setParticipants((prevParticipants) => prevParticipants.filter(participant => participant.name !== message.name));
        break;
      case 'offer':
        handleOffer(message.offer);
        break;
      case 'answer':
        handleAnswer(message.answer);
        break;
      case 'candidate':
        handleCandidate(message.candidate);
        break;
      default:
        break;
    }
  };

  const setupPeerConnection = () => {
    const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    peerConnection.current = new RTCPeerConnection(configuration);

    peerConnection.current.addEventListener('icecandidate', event => {
      if (event.candidate) {
        ws.current.send(JSON.stringify({
          type: 'candidate',
          candidate: event.candidate,
          room: new URLSearchParams(window.location.search).get('room')
        }));
      }
    });

    peerConnection.current.addEventListener('datachannel', event => {
      const receiveChannel = event.channel;
      receiveChannel.onmessage = (event) => {
        console.log('Received Message:', event.data);
        alert('Message: ' + event.data);
      };
    });

    dataChannel.current = peerConnection.current.createDataChannel('chat');
    dataChannel.current.onopen = () => console.log('Data channel is open');
    dataChannel.current.onmessage = (event) => {
      console.log('Received Message:', event.data);
      alert('Message: ' + event.data);
    };

    createOffer();
  };

  const createOffer = async () => {
    const offer = await peerConnection.current.createOffer();
    await peerConnection.current.setLocalDescription(offer);

    ws.current.send(JSON.stringify({
      type: 'offer',
      offer: offer,
      room: new URLSearchParams(window.location.search).get('room')
    }));
  };

  const handleOffer = async (offer) => {
    await peerConnection.current.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peerConnection.current.createAnswer();
    await peerConnection.current.setLocalDescription(answer);

    ws.current.send(JSON.stringify({
      type: 'answer',
      answer: answer,
      room: new URLSearchParams(window.location.search).get('room')
    }));
  };

  const handleAnswer = async (answer) => {
    await peerConnection.current.setRemoteDescription(new RTCSessionDescription(answer));
  };

  const handleCandidate = async (candidate) => {
    await peerConnection.current.addIceCandidate(new RTCIceCandidate(candidate));
  };

  return (
    <div className="min-h-screen bg-zinc-800 text-white p-4">
      <div className="max-w-4xl mx-auto">
        {!showJoinForm && (
          <div className="flex items-center gap-4 justify-center mb-8">
            <input
              type="text"
              value={roomLink}
              readOnly
              className="bg-zinc-700 p-2 rounded w-96 text-white"
            />
            <button
              onClick={copyLink}
              className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded"
            >
              Copy Link
            </button>
          </div>
        )}
        
        <div className="flex flex-wrap gap-4 justify-center">
          {[...Array(12)].map((_, i) => (
            <div
              key={i}
              className={`w-36 h-36 rounded-lg relative flex items-center justify-center ${
                participants[i] ? 'bg-zinc-600' : 'bg-zinc-700 opacity-70'
              }`}
            >
              {participants[i] && (
                <div className="absolute -bottom-6 text-center w-full">{participants[i].name}</div>
              )}
            </div>
          ))}
        </div>

        {showJoinForm && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div className="bg-zinc-700 p-6 rounded-lg shadow-lg">
              <input
                type="text"
                placeholder="Enter your name"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="bg-zinc-600 p-2 rounded mb-4 w-full text-white"
              />
              <button
                onClick={handleJoin}
                className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded w-full"
              >
                Join Room
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default VoiceChatRoom;
