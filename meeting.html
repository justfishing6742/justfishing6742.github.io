<!DOCTYPE html>
<html>
<head>
  <title>EasyPeer2Peer - Voice Chat Room</title>
  <link rel="icon" type="image/png" href="favicon-16x16.png">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #121212;
      color: white;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    .participants {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    .participant {
      width: 150px;
      height: 150px;
      background: #333;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      transition: opacity 0.3s;
    }
    .participant.named {
      opacity: 1;
    }
    .name-tag {
      position: absolute;
      bottom: -25px;
      width: 100%;
      text-align: center;
      font-family: Arial;
    }
    .controls {
      margin: 20px 0;
      display: none;
    }
    .join-controls {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      text-align: center;
    }
    #nameInput {
      padding: 8px;
      margin: 10px;
      width: 200px;
      background: #333;
      border: none;
      border-radius: 5px;
      color: white;
    }
    #roomLink {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      background: #333;
      border: none;
      border-radius: 5px;
      color: white;
    }
    button {
      padding: 10px 20px;
      background: #1e88e5;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #1565c0;
    }
    audio {
      display: none;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCFj83jGuDsGRb4KVRVeBgyQQ0LuiGTufA",
      authDomain: "oaauth-e0c4d.firebaseapp.com",
      projectId: "oaauth-e0c4d",
      storageBucket: "oaauth-e0c4d.firebasestorage.app",
      messagingSenderId: "76089646716",
      appId: "1:76089646716:web:7563461b855ce67e56b3f9",
      measurementId: "G-KJZ6DQD73B"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, user => {
      if (user) {
        console.log('User is signed in:', user.email);
      } else {
        console.log('User is signed out');
      }
    });

    let ws;
    let currentRoom;
    let peerConnection;

    async function initializeRoom() {
      currentRoom = getRoomId();
      addParticipant();

      try {
        ws = new WebSocket('wss://signal-v2-6203u5gsn-cullen-harrisons-projects.vercel.app');
        ws.onopen = () => console.log('WebSocket connection established');
        ws.onmessage = handleMessage;
        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          alert('WebSocket connection error. Please try again later.');
        };
        ws.onclose = (event) => {
          console.log('WebSocket connection closed:', event);
          if (!event.wasClean) {
            alert('WebSocket connection closed unexpectedly. Please try again later.');
          }
        };
      } catch (error) {
        console.error('Failed to establish WebSocket connection:', error);
        alert('Failed to establish WebSocket connection. Please try again later.');
      }
    }

    async function joinRoom() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('WebSocket connection is not ready. Please try again.');
        return;
      }

      const name = document.getElementById('nameInput').value;
      if (!name) return;

      ws.send(JSON.stringify({
        type: 'join',
        name: name,
        room: currentRoom
      }));

      document.getElementById('joinForm').style.display = 'none';
      document.getElementById('controls').style.display = 'block';
      updateParticipantName(name, true);

      const roomUrl = `${window.location.origin}${window.location.pathname}?room=${currentRoom}`;
      document.getElementById('roomLink').value = roomUrl;

      setupPeerConnection();
    }

    function handleMessage(event) {
      const message = JSON.parse(event.data);

      switch (message.type) {
        case 'userJoined':
          if (document.getElementsByClassName('participant').length < 12) {
            addParticipant(message.name);
          }
          break;
        case 'userLeft':
          removeParticipant(message.name);
          break;
        case 'offer':
          handleOffer(message.offer);
          break;
        case 'answer':
          handleAnswer(message.answer);
          break;
        case 'candidate':
          handleCandidate(message.candidate);
          break;
      }
    }

    function addParticipant(name = '') {
      const participantsDiv = document.getElementById('participants');
      const participant = document.createElement('div');
      participant.className = `participant ${name ? 'named' : ''}`;
      participant.id = name ? `participant-${name}` : 'unnamed-participant';

      if (name) {
        const nameTag = document.createElement('div');
        nameTag.className = 'name-tag';
        nameTag.textContent = name;
        participant.appendChild(nameTag);
      }

      participantsDiv.appendChild(participant);
    }

    function updateParticipantName(name, isSelf = false) {
      const participant = document.getElementById('unnamed-participant');
      if (participant) {
        participant.id = `participant-${name}`;
        participant.classList.add('named');

        const nameTag = document.createElement('div');
        nameTag.className = 'name-tag';
        nameTag.textContent = name;
        participant.appendChild(nameTag);
      }
    }

    function removeParticipant(name) {
      const participant = document.getElementById(`participant-${name}`);
      if (participant) participant.remove();
    }

    function getRoomId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('room') || generateRoomId();
    }

    function generateRoomId() {
      return Math.random().toString(36).substring(2, 15);
    }

    function copyLink() {
      const link = document.getElementById('roomLink');
      link.select();
      document.execCommand('copy');
    }

    function setupPeerConnection() {
      const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
      peerConnection = new RTCPeerConnection(configuration);

      peerConnection.addEventListener('icecandidate', event => {
        if (event.candidate) {
          ws.send(JSON.stringify({
            type: 'candidate',
            candidate: event.candidate,
            room: currentRoom
          }));
        }
      });

      peerConnection.addEventListener('datachannel', event => {
        const receiveChannel = event.channel;
        receiveChannel.onmessage = (event) => {
          console.log('Received Message:', event.data);
          alert('Message: ' + event.data);
        };
      });

      const dataChannel = peerConnection.createDataChannel('chat');
      dataChannel.onopen = () => console.log('Data channel is open');
      dataChannel.onmessage = (event) => {
        console.log('Received Message:', event.data);
        alert('Message: ' + event.data);
      };

      createOffer(dataChannel);
    }

    async function createOffer(dataChannel) {
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      ws.send(JSON.stringify({
        type: 'offer',
        offer: offer,
        room: currentRoom
      }));
    }

    async function handleOffer(offer) {
      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
      const